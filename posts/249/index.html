<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Heroku SSL EndpointからAutomated Certificate Managementへ移行する | 雑なアウトプット</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Heroku SSL EndpointからAutomated Certificate Managementへダウンタイムなしで移行したので、その記録。 Heroku SSL化を挟まないと、heroku certs:auto:enableしてからstatus: OKになるまでの間にダウンタイムが発生する。そのあたりの注意点は公式ドキュメントに書いてあった。  https://devcenter.he">
<meta property="og:type" content="article">
<meta property="og:title" content="Heroku SSL EndpointからAutomated Certificate Managementへ移行する">
<meta property="og:url" content="https://ppworks.github.io/posts/249/index.html">
<meta property="og:site_name" content="雑なアウトプット">
<meta property="og:description" content="Heroku SSL EndpointからAutomated Certificate Managementへダウンタイムなしで移行したので、その記録。 Heroku SSL化を挟まないと、heroku certs:auto:enableしてからstatus: OKになるまでの間にダウンタイムが発生する。そのあたりの注意点は公式ドキュメントに書いてあった。  https://devcenter.he">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2018-01-26T04:21:35.618Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Heroku SSL EndpointからAutomated Certificate Managementへ移行する">
<meta name="twitter:description" content="Heroku SSL EndpointからAutomated Certificate Managementへダウンタイムなしで移行したので、その記録。 Heroku SSL化を挟まないと、heroku certs:auto:enableしてからstatus: OKになるまでの間にダウンタイムが発生する。そのあたりの注意点は公式ドキュメントに書いてあった。  https://devcenter.he">
  
    <link rel="alternate" href="/atom.xml" title="雑なアウトプット" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-52654728-4', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  <script type="text/javascript" src="https://s.hatena.ne.jp/js/HatenaStar.js"></script>
  <script type="text/javascript">
    Hatena.Star.Token = 'fc701925dcee0a5423226786dd300651d572ca5e';
    Hatena.Star.SiteConfig = {
      entryNodes: {
        'article.article': [
          {
            uri: 'a.article-title',
            title: 'a.article-title',
            container: 'header.article-header h1'
          },
          {
            uri: 'a.article-title',
            title: 'a.article-title',
            container: '.article-footer'
          }
        ]
      }
    };
  </script>
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">雑なアウトプット</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/posts">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        <a id="nav-github-link" class="nav-icon" href="https://github.com/ppworks/ppworks.github.io" title="GitHub"></a>
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://ppworks.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-249.html" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/posts/249/" class="article-date">
  <time datetime="2017-11-01T06:33:02.000Z" itemprop="datePublished">2017-11-01 06:33:02</time>
</a>

  </div>
  <div class="article-inner">
    

    
      <header class="article-header">
        

  <h1 itemprop="name">
    <a class="article-title" href="/posts/249/">Heroku SSL EndpointからAutomated Certificate Managementへ移行する</a>
  </h1>


      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Heroku SSL EndpointからAutomated Certificate Managementへダウンタイムなしで移行したので、その記録。</p>
<p>Heroku SSL化を挟まないと、<code>heroku certs:auto:enable</code>してから<code>status: OK</code>になるまでの間にダウンタイムが発生する。そのあたりの注意点は公式ドキュメントに書いてあった。</p>
<blockquote>
<p><a href="https://devcenter.heroku.com/articles/automated-certificate-management#migrating-from-ssl-endpoint" target="_blank" rel="noopener">https://devcenter.heroku.com/articles/automated-certificate-management#migrating-from-ssl-endpoint</a><br>Migrating from the SSL Endpoint addon to Automated Certificate Management requires a DNS change. However, you can use Heroku SSL (SNI) as an intermediate step to avoid downtime for your custom domain. Start by following these instructions to migrate from SSL Endpoint to Heroku SSL (SNI). Once that process is complete, you can enable ACM with no downtime as described above.</p>
</blockquote>
<p>いちど、Heroku SSLへ移行してから、ACM(Automated Certificate Management)へ移行すればいい。</p>
<p>Heroku SSLを使うには、<code>heroku certs:add</code>コマンドに<code>--type sni</code>オプションを付けて証明書を追加する。</p>
<p>このとき、既存の証明書と同じものをアップロードしてオッケー。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">heroku certs:add example.com.crt example.com.key --type sni</span><br></pre></td></tr></table></figure>
<p>すると、こんな感じで2つの証明書が表示される。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">heroku certs -a pplog</span><br><span class="line">Name                Endpoint                  Common Name(s)            Expires               Trusted  Type</span><br><span class="line">──────────────────  ────────────────────────  ────────────────────────  ──────────</span><br><span class="line">gifu-1545           gifu-1545.herokussl.com   www.pplog.net, pplog.net  2018-01-30 03:10 UTC  True     Endpoint</span><br><span class="line">camarasaurus-91097  (Not applicable for SNI)  www.pplog.net, pplog.net  2018-01-30 03:10 UTC  True     SNI</span><br></pre></td></tr></table></figure>
<p>ドメインを確認すると</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">heroku domains -a pplog</span><br><span class="line">=== pplog Heroku Domain</span><br><span class="line">pplog.herokuapp.com</span><br><span class="line"></span><br><span class="line">=== pplog Custom Domains</span><br><span class="line">Domain Name    DNS Record Type  DNS Target</span><br><span class="line">─────────────  ───────────────  ───────────────────────────</span><br><span class="line">www.pplog.net  CNAME            www.pplog.net.herokudns.com</span><br><span class="line">pplog.net      ALIAS or ANAME   pplog.net.herokudns.com</span><br></pre></td></tr></table></figure>
<p><code>CNAME</code>と<code>ALIAS</code>に設定すべき項目が表示されるので、これらをDNSの設定に反映する。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig CNAME www.pplog.net</span><br></pre></td></tr></table></figure>
<p>TTLの設定に寄るけども、DNS反映されたら、<code>Heroku SSL Endpoint</code>のアドオンを削除する。（焦らなくてもいいので次の日にでも）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">heroku addons:destroy ssl -a pplog</span><br></pre></td></tr></table></figure>
<p><code>Automated Certificate Management</code>を有効にする。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">heroku certs:auto:enable -a pplog</span><br><span class="line">Enabling Automatic Certificate Management... done</span><br></pre></td></tr></table></figure>
<p>すぐに確認すると、<code>In Progress</code>になっている。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">heroku certs:auto -a pplog</span><br><span class="line">=== Automatic Certificate Management is enabled on pplog</span><br><span class="line"></span><br><span class="line">Domain         Status</span><br><span class="line">─────────────  ───────────</span><br><span class="line">www.pplog.net  In Progress</span><br><span class="line">pplog.net      In Progress</span><br></pre></td></tr></table></figure>
<p>しばらくすると、<code>OK</code>になる。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">heroku certs:auto -a pplog</span><br><span class="line">=== Automatic Certificate Management is enabled on pplog</span><br><span class="line"></span><br><span class="line">Certificate details:</span><br><span class="line">Common Name(s): pplog.net</span><br><span class="line">                www.pplog.net</span><br><span class="line">Expires At:     2018-01-30 04:51 UTC</span><br><span class="line">Issuer:         /C=US/O=Let&apos;s Encrypt/CN=Let&apos;s Encrypt Authority X3</span><br><span class="line">Starts At:      2017-11-01 04:51 UTC</span><br><span class="line">Subject:        /CN=pplog.net</span><br><span class="line">SSL certificate is verified by a root authority.</span><br><span class="line"></span><br><span class="line">Domain         Status</span><br><span class="line">─────────────  ──────</span><br><span class="line">www.pplog.net  OK</span><br><span class="line">pplog.net      OK</span><br></pre></td></tr></table></figure>
<p>証明書の<code>Type</code>が<code>ACM</code>になっていれば完了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">heroku certs -a pplog</span><br><span class="line">Name                Common Name(s)            Expires               Trusted  Type</span><br><span class="line">──────────────────  ────────────────────────  ────────────────────  ───────  ────</span><br><span class="line">camarasaurus-91097  pplog.net, www.pplog.net  2018-01-30 04:51 UTC  True     ACM</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://ppworks.github.io/posts/249/" data-id="cjcvf7y14000f892qe1gkbds3" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/posts/237/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Docker を使ってみる
        
      </div>
    </a>
  
  
    <a href="/posts/250/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Dockerでrails new</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/posts/270/">uGUIについて学ぶ</a>
          </li>
        
          <li>
            <a href="/posts/268/">Unityで「もぐらたたきゲーム」を作ってみる1</a>
          </li>
        
          <li>
            <a href="/posts/262/">esaのslideをembedする</a>
          </li>
        
          <li>
            <a href="/posts/253/">Hexo の archives の表示順序を変える</a>
          </li>
        
          <li>
            <a href="/posts/251/">Dockerでrails s</a>
          </li>
        
      </ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/esa/" style="font-size: 10px;">esa</a> <a href="/tags/hexo/" style="font-size: 20px;">hexo</a> <a href="/tags/rails/" style="font-size: 10px;">rails</a> <a href="/tags/unity/" style="font-size: 15px;">unity</a>
    </div>
  </div>

  
    <div class="widget-wrap">
  <h3 class="widget-title">Builds</h3>
  <div class="widget">
    <a href="https://travis-ci.org/ppworks/ppworks.github.io/builds"><img class="travis-badge" src="https://travis-ci.org/ppworks/ppworks.github.io.svg?branch=esa" /></a>
    <ul id="js-travis-ci-builds" class="travis-list">
    </ul>
  </div>
</div>

  
    <div class="widget-wrap">
  <h3 class="widget-title">Links</h3>
  <div class="widget">
    <ul>
      <li><a href="https://taea.github.io">taea.github.io</a></li>
    </ul>
  </div>
</div>

  
</aside>

        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 ppworks<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/posts" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.19.1/moment.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>



<script src="/js/script.js"></script>

  </div>
</body>
</html>